<body>
    <div class="dashboard-container">
        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Content -->
            <main class="dashboard-content">
                <!-- Page Header -->
                <div class="page-header">
                    <div class="page-title-section">
                        <h2 class="page-title">Quản lý lớp học</h2>
                        <p class="page-subtitle">Quản lý thông tin các lớp học và sinh viên</p>
                    </div>
                    <div class="page-actions">
                        <button class="btn btn-primary" (click)="exportMyClasses()">
                            <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                            </svg>
                            Xuất dữ liệu
                        </button>
                    </div>
                </div>

                <!-- Class Management -->
                <div class="class-management">
                    <div class="class-header">
                        <h3>Danh sách lớp học</h3>
                        <div class="class-actions">
                            <span style="color: #64748b; font-size: 14px;">Tổng: {{ filteredClassList.length }} lớp
                                học</span>
                        </div>
                    </div>

                    <div class="search-filter-bar">
                        <div class="search-box">
                            <svg class="search-icon" width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                                <path
                                    d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
                            </svg>
                            <input class="search-input" type="text" placeholder="Tìm kiếm lớp học..."
                                [(ngModel)]="searchText" (input)="searchClasses()">
                        </div>

                        <div class="filter-actions">
                            <button class="btn btn-outline" (click)="sortByName()">
                                <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M3 18h6v-2H3v2zM3 6v2h18V6H3zm0 7h12v-2H3v2z" />
                                </svg>
                                Sắp xếp theo tên
                            </button>
                            <button class="btn btn-outline" (click)="sortBystatus()">
                                Hủy
                            </button>
                        </div>
                    </div>

                    <div class="class-table-container">
                        <table class="class-table">
                            <thead>
                                <tr>
                                    <th>STT</th>
                                    <th>Tên lớp học</th>
                                    <th>Số sinh viên</th>
                                    <th>Số sinh viên có vân tay</th>
                                    <th>Ngày tạo</th>
                                    <th>Trạng thái</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="classTableBody">
                                <tr *ngFor="let lop of  filteredClassList; let i = index"
                                    (click)="openClassDeatilModal(lop)">
                                    <td>{{i+1}}</td>
                                    <td>
                                        <div class="class-info">
                                            <div class="class-details">
                                                <h4>{{lop.tenLop}}</h4>
                                                <div class="class-code">{{lop.classCode}}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="student-count">
                                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                                <path
                                                    d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zM4 18v-4h3v4h2v-7.5c0-.83.67-1.5 1.5-1.5S12 9.67 12 10.5V11h2.5c.83 0 1.5.67 1.5 1.5V18h2v4H4v-4z" />
                                            </svg>
                                            {{lop.soHocSinh}} sinh viên
                                        </div>
                                    </td>
                                    <td>
                                        <div class="date-created"> {{ lop.soSvCoVanTay }} sinh viên</div>
                                    </td>
                                    <td>
                                        <div class="date-created">{{lop.ngayTao}}</div>
                                    </td>
                                    <td>
                                        <span class="status-badge" [ngClass]="{ 
                                                                                    'active': lop.trangThai === 'Hoạt động', 
                                                                                    'inactive': lop.trangThai === 'Tạm dừng' 
                                                                                    }"
                                            (click)="toggleClassStatus(lop); $event.stopPropagation()"
                                            style="cursor: pointer;">
                                            {{ lop.trangThai }}
                                        </span>
                                    </td>


                                    <td>
                                        <div class="action-buttons">
                                            <!-- NÚT XUẤT DỮ LIỆU LỚP -->
                                            <button class="btn-icon btn-export" title="Xuất CSV lớp này"
                                                (click)="exportClassStudents(lop); $event.stopPropagation()">
                                                <!-- icon download -->
                                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                                    <path d="M5 20h14v-2H5v2zm7-18L5.33 9h3.84v4h4.66V9h3.84L12 2z" />
                                                </svg>
                                            </button>
                                            <button class="btn-icon btn-delete"
                                                (click)="openDeleteModal();$event.stopPropagation() ">
                                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                                    <path
                                                        d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" />
                                                </svg>
                                            </button>
                                        </div>
                                    </td>
                                </tr>

                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>

        <!-- Class Detail Modal -->
        <div class="modal-overlay active" *ngIf="showClassDetailModal">
            <div class="modal" style="max-width: 900px;">
                <div class="modal-header">
                    <div class="modal-icon info">
                        <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                            <path
                                d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
                        </svg>
                    </div>
                    <h3 class="modal-title" id="detailModalTitle">Chi tiết lớp học</h3>
                </div>

                <!-- THÔNG TIN LỚP (READONLY) -->
                <div class="class-detail-form">
                    <div class="class-detail-grid">
                        <div class="form-group">
                            <label class="form-label">Tên lớp học</label>
                            <input type="text" class="form-input" [value]="selectedClass?.tenLop" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Mã lớp</label>
                            <input type="text" class="form-input" [value]="selectedClass?.classCode" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Giảng viên</label>
                            <input type="text" class="form-input"
                                [value]="selectedClass?.teacherName || 'Giảng viên hiện tại'" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ngày tạo</label>
                            <input type="text" class="form-input" [value]="selectedClass?.ngayTao" readonly>
                        </div>
                    </div>
                </div>

                <!-- KHU VỰC THÊM SINH VIÊN -->
                <div class="student-management">
                    <!-- Form thêm SV -->
                    <div class="student-section">
                        <h4 class="section-title">Thêm sinh viên vào lớp</h4>

                        <div class="student-add-row">
                            <div class="form-group" style="min-width: 140px;">
                                <label class="form-label">MSSV</label>
                                <input type="number" class="form-input" [(ngModel)]="newStudentIdInput"
                                    (keyup.enter)="searchStudent()" placeholder="Nhập MSSV (StudentId)">
                            </div>

                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Họ tên sinh viên</label>
                                <input type="text" class="form-input" [value]="searchedStudent?.fullName || ''"
                                    readonly>
                            </div>

                            <div class="form-group" style="display: flex; align-items: flex-end; gap: 8px;">
                                <button class="modal-btn modal-btn-secondary" type="button" (click)="searchStudent()">
                                    Tìm
                                </button>

                                <button class="btn-icon btn-confirm" type="button" [disabled]="!searchedStudent"
                                    (click)="addPendingStudent()" title="Thêm sinh viên (tạm)">
                                    <!-- tick xanh -->
                                    <svg width="20" height="20" viewBox="0 0 24 24">
                                        <path fill="#16a34a" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <div class="error-text" *ngIf="searchStudentError">
                            {{ searchStudentError }}
                        </div>
                    </div>

                    <!-- Danh sách SV trong lớp -->
                    <div class="student-section">
                        <!-- THANH TÌM KIẾM SINH VIÊN TRONG LỚP -->
                        <div style="margin: 10px 0;">
                            <input type="text" class="form-input" placeholder="Tìm kiếm sinh viên theo tên hoặc MSSV..."
                                [(ngModel)]="studentSearchText" (input)="filterDisplayedStudents()"
                                style="width: 100%;">
                        </div>

                        <h4 class="section-title">
                            Danh sách sinh viên trong lớp
                            ({{ getDisplayedStudents().length }})
                        </h4>

                        <div class="student-list" id="currentStudents">
                            <div class="student-item" *ngFor="let st of filteredStudents">
                                <div class="student-info">
                                    <div class="student-details">
                                        <h5>{{ st.fullName }}</h5>
                                        <p>MSSV: {{ st.studentId }} &nbsp;|&nbsp; Username: {{ st.username }}</p>
                                        <p>Email: {{ st.email }}</p>
                                    </div>
                                </div>

                                <div class="student-actions">
                                    <span class="badge-new" *ngIf="isPendingAdd(st.studentId)">
                                        Mới thêm
                                    </span>

                                    <button class="btn-remove" type="button" (click)="markRemoveStudent(st)">
                                        Xóa
                                    </button>
                                </div>
                            </div>

                            <div *ngIf="getDisplayedStudents().length === 0" style="padding: 8px 0; color: #777;">
                                Chưa có sinh viên nào trong lớp.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ACTIONS -->
                <div class="modal-actions">
                    <button class="modal-btn modal-btn-secondary" type="button" (click)="closeClassDetailModal()">
                        Đóng
                    </button>
                    <button class="modal-btn modal-btn-primary" type="button" (click)="saveClassChanges()">
                        Lưu thay đổi
                    </button>
                </div>
            </div>
        </div>

        <!-- Notification Modal -->
        <div class="modal-overlay active" *ngIf="showNotificationModal">
            <div class="modal">
                <div class="modal-header">
                    <div class="modal-icon">
                        <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
                        </svg>
                    </div>
                    <h3 class="modal-title">Thành công!</h3>
                </div>
                <p class="modal-message">Thao tác đã được thực hiện thành công.</p>
                <div class="modal-actions">
                    <button class="modal-btn modal-btn-primary" (click)="closeNotificationModal()">Đóng</button>
                </div>
            </div>
        </div>

        

    </div>
</body>