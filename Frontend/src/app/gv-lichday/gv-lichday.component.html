<body>
    <div class="dashboard-container">
        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Content -->
            <div class="dashboard-content">
                <!-- Page Header -->
                <div class="page-header">
                    <div class="page-title-section">
                        <h2 class="page-title">Quản lý lịch dạy theo ngày</h2>
                        <p class="page-subtitle">
                            Chọn ngày trên lịch để xem danh sách các lớp bạn dạy trong ngày đó
                        </p>
                    </div>
                </div>

                <!-- ✅ PHẦN LỊCH -->
                <div class="calendar-section">
                    <div class="calendar-header">
                        <h3 class="calendar-title">Lịch dạy tháng {{ currentMonthLabel }}</h3>
                        <div class="calendar-nav">
                            <button class="calendar-nav-btn" (click)="previousMonth()">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
                                </svg>
                            </button>
                            <span class="calendar-month">{{ currentMonthLabel }}</span>
                            <button class="calendar-nav-btn" (click)="nextMonth()">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="calendar-grid">
                        <div class="calendar-day-header">CN</div>
                        <div class="calendar-day-header">T2</div>
                        <div class="calendar-day-header">T3</div>
                        <div class="calendar-day-header">T4</div>
                        <div class="calendar-day-header">T5</div>
                        <div class="calendar-day-header">T6</div>
                        <div class="calendar-day-header">T7</div>

                        <!-- Hiển thị ngày -->
                        <ng-container *ngFor="let day of calendarDays">
                            <div class="calendar-day" *ngIf="!day.isEmpty" [class.today]="day.isToday"
                                [class.selected]="day.isSelected" [class.has-attendance]="day.hasAttendance"
                                (click)="selectDate(day.dateStr!)">
                                <div class="day-number">{{ day.dayNumber }}</div>
                                <div class="day-classes">
                                    {{ day.classCount && day.classCount > 0 ? day.classCount + ' lớp' : '' }}
                                </div>
                            </div>

                            <!-- Ô trống đầu tháng -->
                            <div class="calendar-day other-month" *ngIf="day.isEmpty"></div>
                        </ng-container>
                    </div>
                </div>

                <!-- DANH SÁCH LỚP DẠY TRONG NGÀY  -->
                <div class="schedule-list">
                    <div class="schedule-list-header">
                        <h3 class="schedule-list-title">
                            Các lớp dạy ngày {{ selectedDate | date:'dd/MM/yyyy' }}
                        </h3>
                        <span class="schedule-list-info">
                            {{ classesOfSelectedDay.length }} lớp học
                        </span>
                    </div>

                    <div class="schedule-table-container">
                        <table class="schedule-table">
                            <thead>
                                <tr>
                                    <th>STT</th>
                                    <th>Lớp học</th>
                                    <th>Phòng học</th>
                                    <th>Thời gian</th>
                                    <th>Trạng thái lớp</th>
                                    <th>Số sinh viên</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- mỗi lớp là 1 dòng, click để mở chi tiết điểm danh -->
                                <tr *ngFor="let cls of classesOfSelectedDay; let i = index" style="cursor: pointer;"
                                    (click)="onClassRowClick(cls)" [class.cancelled]="!cls.isActive">
                                    <td>{{ i + 1 }}</td>
                                    <td>
                                        <div class="class-info">
                                            <div class="class-details">
                                                <h5>{{ cls.className }}</h5>
                                                <p>{{ cls.classCode }}</p>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="class-info">
                                            <div class="class-details">
                                                <h5>{{ cls.room }}</h5>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        {{ cls.startTime | slice:0:5 }} - {{ cls.endTime | slice:0:5 }}
                                    </td>
                                    <td>
                                        <span class="class-status" [ngClass]="getStatusClass(cls)">
                                            {{ getStatusText(cls) }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="student-count">{{ cls.studentCount }}</span>
                                    </td>
                                </tr>

                                <!-- Nếu không có lớp nào -->
                                <tr *ngIf="classesOfSelectedDay.length === 0">
                                    <td colspan="5" style="text-align: center; padding: 12px 0;">
                                        Không có lớp dạy trong ngày này
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

      
                <!-- CHI TIẾT ĐIỂM DANH LỚP (ATTENDANCE) -->
                <div id="attendanceDetailSection" class="attendance-detail-section show" *ngIf="selectedClass">

                    <div class="attendance-list-header">
                        <h3 class="attendance-list-title">
                            Chi tiết điểm danh -
                            <span>Lớp {{ selectedClass.className }} ({{ selectedClass.classCode }})</span>
                        </h3>

                        <button class="btn btn-primary" (click)="onExportReport()"
                            [disabled]="attendanceRows.length === 0">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                <path
                                    d="M20,8L12,13L4,8V6L12,11L20,6M20,4H4C2.89,4 2,4.89 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V6C22,5.89 21.1,4 20,4Z" />
                            </svg>
                            Xuất báo cáo
                        </button>
                    </div>

                    <div class="attendance-table-container" *ngIf="!attendanceLoading; else loadingAttendance">
                        <div style="padding: 32px;">

                            <!-- Info grid -->
                            <div class="modal-info-grid">
                                <div class="modal-info-card">
                                    <div class="info-label">Mã lớp</div>
                                    <div class="info-value">{{ selectedClass.classCode }}</div>
                                </div>
                                <div class="modal-info-card">
                                    <div class="info-label">Phòng học</div>
                                    <div class="info-value">{{ selectedClass.room }}</div>
                                </div>
                                <div class="modal-info-card">
                                    <div class="info-label">Thời gian</div>
                                    <div class="info-value">
                                        {{ selectedClass.startTime | slice:0:5 }}
                                        -
                                        {{ selectedClass.endTime | slice:0:5 }}
                                    </div>
                                </div>
                                <div class="modal-info-card">
                                    <div class="info-label">Ngày dạy</div>
                                    <div class="info-value">
                                        {{ selectedDate | date:'dd/MM/yyyy' }}
                                    </div>
                                </div>
                            </div>

                            <!-- Stats -->
                            <div class="modal-stats">
                                <div class="stat-item">
                                    <div class="stat-number">{{ attendanceStats.total }}</div>
                                    <div class="stat-label">Tổng sinh viên</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-number present">{{ attendanceStats.present }}</div>
                                    <div class="stat-label">Có mặt</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-number absent">{{ attendanceStats.absent }}</div>
                                    <div class="stat-label">Vắng mặt</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-number rate">{{ attendanceStats.rate }}%</div>
                                    <div class="stat-label">Tỷ lệ tham gia</div>
                                </div>
                            </div>

                            <!-- Danh sách điểm danh sinh viên -->
                            <div class="student-list-section">
                                <h4 class="section-title">Danh sách điểm danh sinh viên</h4>

                                <div class="student-table-container">
                                    <table class="student-table">
                                        <thead>
                                            <tr>
                                                <th>STT</th>
                                                <th>Sinh viên</th>
                                                <th>Trạng thái tham gia</th>
                                                <th>Giờ tham gia</th>
                                                <th>Thao tác</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Dòng dữ liệu -->
                                            <tr *ngFor="let s of attendanceRows; let i = index"
                                                style="cursor: pointer;">
                                                <td>{{ i + 1 }}</td>
                                                <td>
                                                    <div class="student-info">
                                                        <div class="student-details">
                                                            <div class="student-name">{{ s.fullName }}</div>
                                                            <div class="student-id">MSSV: {{ s.studentCode }}</div>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    <span class="attendance-status" (click)="onToggleStatus(s)"
                                                        [ngClass]="{
                          'present': s.status === 'present',
                          'absent':  s.status === 'absent',
                          'late':    s.status === 'late',
                        }">
                                                        {{ s.status === 'present'
                                                        ? 'Có mặt'
                                                        : s.status === 'absent'
                                                        ? 'Vắng mặt'
                                                        : s.status === 'late'
                                                        ? 'Đi muộn'
                                                        : '--' }}
                                                    </span>
                                                </td>
                                                <td>{{ s.attendanceTime || '-' }}</td>
                                                <td>
                                                    <div class="action-buttons">
                                                        <button class="btn-icon btn-view" title="Chi tiết sinh viên"
                                                            (click)="openStudentDetail(s, $event)">
                                                            <svg width="16" height="16" fill="currentColor"
                                                                viewBox="0 0 24 24">
                                                                <path
                                                                    d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L15 1H5C3.89 1 3 1.89 3 3V21C3 22.11 3.89 23 5 23H19C20.11 23 21 22.11 21 21V9M19 21H5V3H13V9H19V21Z" />
                                                            </svg>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>

                                            <!-- Không có dữ liệu -->
                                            <tr *ngIf="attendanceRows.length === 0">
                                                <td colspan="7" style="text-align: center; padding: 12px 0;">
                                                    Không có dữ liệu điểm danh cho buổi này
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                        </div>
                    </div>

                    <ng-template #loadingAttendance>
                        <div style="padding: 32px; text-align: center;">
                            Đang tải dữ liệu điểm danh...
                        </div>
                    </ng-template>
                </div>
                <!-- Student Detail Modal -->
                <div class="modal active" *ngIf="showStudentDetailModal && studentDetail">
                    <div class="modal-content" style="max-width: 1000px;">
                        <div class="modal-header">
                            <h3 class="modal-title">Chi tiết sinh viên</h3>
                            <button class="modal-close" (click)="closeStudentDetailModal()">
                                <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                                    <path
                                        d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
                                </svg>
                            </button>
                        </div>

                        <div class="modal-body">
                            <!-- Student Basic Info -->
                            <div class="student-profile-section">
                                <div class="student-profile-header">
                                    <div class="student-avatar-large" id="modalStudentAvatar">
                                        {{ (studentDetail.fullName || 'SV') | slice:0:1 }}
                                    </div>
                                    <div class="student-profile-info">
                                        <h3 class="student-profile-name">
                                            {{ studentDetail.fullName }}
                                        </h3>
                                        <p class="student-profile-id">
                                            {{ studentDetail.studentCode }}
                                        </p>
                                        <div class="student-profile-stats">
                                            <div class="profile-stat">
                                                <span class="profile-stat-label">Email:</span>
                                                <span class="profile-stat-value">{{ studentDetail.email }}</span>
                                            </div>
                                            <div class="profile-stat">
                                                <span class="profile-stat-label">SĐT:</span>
                                                <span class="profile-stat-value">{{ studentDetail.phone }}</span>
                                            </div>
                                            <div class="profile-stat">
                                                <span class="profile-stat-label">Lớp:</span>
                                                <span class="profile-stat-value">
                                                    {{ studentDetail.classCode }} - {{ studentDetail.className }}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Attendance Statistics -->
                            <div class="modal-stats">
                                <div class="stat-item">
                                    <div class="stat-number">{{ studentDetail.totalSessions || 0 }}</div>
                                    <div class="stat-label">Tổng buổi học</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-number present">{{ studentDetail.presentSessions || 0 }}</div>
                                    <div class="stat-label">Có mặt</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-number late">{{ studentDetail.lateSessions || 0 }}</div>
                                    <div class="stat-label">Muộn</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-number absent">{{ studentDetail.absentSessions || 0 }}</div>
                                    <div class="stat-label">Vắng mặt</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-number rate">
                                        {{ studentDetail.attendanceRate || 0 | number:'1.0-0' }}%
                                    </div>
                                    <div class="stat-label">Tỷ lệ tham gia</div>
                                </div>
                            </div>

                            <!-- Attendance History -->
                            <div class="attendance-history-section">
                                <h4 class="section-title">Lịch sử điểm danh gần đây</h4>

                                <div class="history-table-container">
                                    <table class="history-table">
                                        <thead>
                                            <tr>
                                                <th>STT</th>
                                                <th>Ngày</th>
                                                <th>Thời gian</th>
                                                <th>Trạng thái</th>
                                                <th>Giờ điểm danh</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr *ngFor="let h of studentDetail.history; let i = index">
                                                <td>{{ i + 1 }}</td>
                                                <td>{{ formatDate(h.date) }}</td>
                                                <td>{{ h.sessionTime }}</td>
                                                <td>
                                                    <span class="attendance-status"
                                                        (click)="onToggleHistoryStatus(h, $event)" [ngClass]="{
                          'present': h.status === 'present',
                          'late'   : h.status === 'late',
                          'absent' : h.status === 'absent'
                        }" (click)="onToggleHistoryStatus(h, $event)" style="cursor: pointer;"
                                                        title="Click để đổi trạng thái">
                                                        {{ h.status === 'present'
                                                        ? 'Có mặt'
                                                        : (h.status === 'late' ? 'Muộn' : 'Vắng mặt') }}
                                                    </span>
                                                </td>
                                                <td>{{ h.attendanceTime || '-' }}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>