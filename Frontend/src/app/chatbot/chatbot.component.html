<body>
  <div class="app-container">
    <main class="main-content">
      <div class="content-panel ai-class-review-layout">
        <div class="page-view active">
          <div class="main-panel ai-panel">
            <!-- Header -->
            <div class="panel-header ai-panel-header">
              <div>
                <h2 class="panel-title">
                  AI Nhận xét &amp; Cảnh báo lớp học
                </h2>
                <p class="ai-panel-subtitle">
                  Phân tích dữ liệu điểm danh các tuần gần đây để hỗ trợ giảng viên quản lý lớp học hiệu quả hơn.
                </p>
              </div>

              <div class="ai-header-meta">
                <!-- BỘ CHỌN LỚP - NẾU KHÔNG CẦN CÓ THỂ XOÁ CẢ BLOCK NÀY -->
                <div class="ai-class-select-wrapper">
                  <span class="ai-class-select-label">Chọn lớp</span>
                  <select class="ai-class-select">
                    <option>CT101 - Lập trình Cơ bản</option>
                    <option>CT201 - Cấu trúc dữ liệu</option>
                    <option>CT301 - Cơ sở dữ liệu</option>
                  </select>
                </div>
                <!-- HẾT BỘ CHỌN LỚP -->

                <div class="ai-class-tag">
                  <span class="ai-class-code">Lớp: CT101 - Lập trình Cơ bản</span>
                  <span class="ai-class-info-dot"></span>
                  <span class="ai-class-semester">HK1 / Năm học 2024-2025</span>
                </div>

                <div class="ai-badge" [ngClass]="{
                    'ai-badge-low': (analysis?.overallStatistics?.attendanceRate ?? 0) >= 85,
                    'ai-badge-medium': (analysis?.overallStatistics?.attendanceRate ?? 0) >= 70 && (analysis?.overallStatistics?.attendanceRate ?? 0) < 85,
                    'ai-badge-high': (analysis?.overallStatistics?.attendanceRate ?? 0) < 70
                  }">
                  <span class="ai-badge-label">Mức rủi ro tổng thể</span>
                  <span class="ai-badge-value">
                    {{ (analysis?.overallStatistics?.attendanceRate ?? 0) >= 85 ? 'LOW' : ((analysis?.overallStatistics?.attendanceRate ?? 0) >= 70 ? 'MEDIUM' : 'HIGH') }}
                  </span>
                </div>
              </div>
            </div>

            <!-- Body -->
            <div class="panel-body ai-panel-body">
              <div class="ai-grid">
                <!-- Cột trái: tóm tắt, điểm nổi bật, khuyến nghị -->
                <div class="ai-main-column">
                  <!-- Tóm tắt -->
                  <section class="form-section ai-section">
                    <div class="form-section-title ai-section-title">
                      <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M4 4h16v2H4zm0 4h10v2H4zm0 4h16v2H4zm0 4h10v2H4z" />
                      </svg>
                      Tóm tắt tình hình chuyên cần
                    </div>
                    <div class="ai-summary-text" *ngIf="analysis as a">
                      Trong {{ a.weeklyTrend?.length || 0 }} tuần gần đây, lớp duy trì tỉ lệ đi học trung bình
                      <span class="ai-highlight-number">{{ a.overallStatistics?.attendanceRate | number:'1.0-1' }}%</span>.
                    </div>

                    <div class="ai-summary-tags">
                      <span class="ai-tag ai-tag-good" *ngIf="(analysis?.overallStatistics?.attendanceRate ?? 0) >= 85">Tỉ lệ đi học ổn</span>
                      <span class="ai-tag ai-tag-warning" *ngIf="(analysis?.overallStatistics?.attendanceRate ?? 0) >= 70 && (analysis?.overallStatistics?.attendanceRate ?? 0) < 85">Cần chú ý</span>
                      <span class="ai-tag ai-tag-critical" *ngIf="(analysis?.overallStatistics?.attendanceRate ?? 0) < 70">Rủi ro cao</span>
                    </div>
                  </section>

                  <!-- Điểm nổi bật -->
                  <section class="form-section ai-section">
                    <div class="form-section-title ai-section-title">
                      <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M11 7h2v2h-2zm0 4h2v6h-2zm1-9C6.48 2 2 6.48 2 12s4.48 10 10 10
                               10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8
                               8-8 8 3.59 8 8-3.59 8-8 8z" />
                      </svg>
                      Điểm nổi bật từ dữ liệu
                    </div>
                    <ul class="ai-highlight-list" *ngIf="analysis as a">
                      <li>
                        <span class="dot"></span>
                        Tỉ lệ đi học trung bình toàn lớp trong {{ a.weeklyTrend?.length || 0 }} tuần gần đây đạt
                        <strong>{{ a.overallStatistics?.attendanceRate | number:'1.0-1' }}%</strong>.
                      </li>
                      <li *ngIf="a.overallStatistics">
                        <span class="dot"></span>
                        Tổng số bản ghi: <strong>{{ a.overallStatistics.totalRecords }}</strong>, Vắng: <strong>{{ a.overallStatistics.absentCount }}</strong>, Đi muộn: <strong>{{ a.overallStatistics.lateCount }}</strong>.
                      </li>
                    </ul>
                  </section>

                  <!-- Khuyến nghị -->
                  <section class="form-section ai-section">
                    <div class="form-section-title ai-section-title">
                      <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M13 2.05v3.03c2.83.47 5 2.94 5 5.92 0 3.31-2.69 6-6
                               6s-6-2.69-6-6c0-2.98 2.17-5.45 5-5.92V2.05C7.06 2.55 4
                               5.92 4 9.99 4 14.41 7.59 18 12 18s8-3.59
                               8-8.01C20 5.92 16.94 2.55 13 2.05zM11 8h2v5h-2zm0 7h2v2h-2z" />
                      </svg>
                      Gợi ý hành động cho giảng viên
                    </div>
                    <div class="ai-recommendations" *ngIf="analysis?.recommendations as recs">
                      <div class="ai-recommendation-card" *ngFor="let r of recs">
                        <div class="ai-recommendation-title">✔ Khuyến nghị</div>
                        <div class="ai-recommendation-text">{{ r }}</div>
                      </div>
                    </div>
                  </section>
                </div>

                <!-- Cột phải: thống kê + sinh viên nguy cơ cao -->
                <div class="ai-side-column">
                  <!-- Thống kê nhanh -->
                  <section class="form-section ai-section">
                    <div class="form-section-title ai-section-title">
                      <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M3 17h18v2H3zm2-7h3v5H5zm5-4h3v9h-3zm5 6h3v3h-3z" />
                      </svg>
                      Tổng quan chuyên cần
                    </div>
                    <div class="ai-stat-grid">
                      <div class="ai-stat-card" *ngIf="analysis as a">
                        <div class="ai-stat-label">Số tuần phân tích</div>
                        <div class="ai-stat-value">{{ a.weeklyTrend?.length || 0 }} tuần</div>
                        <div class="ai-stat-hint">Tính từ tuần hiện tại trở về trước</div>
                      </div>
                      <div class="ai-stat-card">
                        <div class="ai-stat-label">Tỉ lệ đi học trung bình</div>
                        <div class="ai-stat-value ai-stat-good">{{ analysis?.overallStatistics?.attendanceRate | number:'1.0-1' }}%</div>
                        <div class="ai-stat-bar">
                          <div class="ai-stat-bar-fill good" [style.width.%]="analysis?.overallStatistics?.attendanceRate || 0"></div>
                        </div>
                      </div>
                      <div class="ai-stat-card">
                        <div class="ai-stat-label">Tỉ lệ vắng trung bình</div>
                        <div class="ai-stat-value ai-stat-warning">{{ ((analysis?.overallStatistics?.absentCount || 0) / (analysis?.overallStatistics?.totalRecords || 1)) * 100 | number:'1.0-1' }}%</div>
                        <div class="ai-stat-bar">
                          <div class="ai-stat-bar-fill warning" [style.width.%]="((analysis?.overallStatistics?.absentCount || 0) / (analysis?.overallStatistics?.totalRecords || 1)) * 100"></div>
                        </div>
                      </div>
                      <div class="ai-stat-card">
                        <div class="ai-stat-label">Sinh viên nguy cơ cao</div>
                        <div class="ai-stat-value ai-stat-critical">{{ analysis?.highRiskStudents?.length || 0 }}</div>
                        <div class="ai-stat-hint">Vắng ≥ 3 buổi hoặc vắng liên tiếp</div>
                      </div>
                    </div>
                  </section>

                  <!-- Xu hướng theo tuần -->
                  <section class="form-section ai-section">
                    <div class="form-section-title ai-section-title">
                      <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M3 17h18v2H3V5h2v10zm4.5-3.5L11 9l2.5 3 3.5-4.5 2.5 3.01V5h-7.5z" />
                      </svg>
                      Xu hướng vắng theo tuần
                    </div>
                    <div class="ai-weeks-timeline" *ngIf="analysis?.weeklyTrend as weeks">
                      <div class="ai-week-row" *ngFor="let w of weeks; let i = index">
                        <div class="ai-week-label">Tuần {{ i === 0 ? 'hiện tại' : '-' + i }}</div>
                        <div class="ai-week-bar">
                          <div class="ai-week-bar-fill warning" [style.width.%]="((w.absent || 0) / ((w.present || 0) + (w.absent || 0) + (w.late || 0) || 1)) * 100"></div>
                        </div>
                        <div class="ai-week-value">{{ ((w.absent || 0) / ((w.present || 0) + (w.absent || 0) + (w.late || 0) || 1)) * 100 | number:'1.0-1' }}% vắng</div>
                      </div>
                    </div>
                  </section>

                  <!-- Sinh viên nguy cơ cao -->
                  <section class="form-section ai-section">
                    <div class="form-section-title ai-section-title">
                      <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4
                               1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8
                               1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                      </svg>
                      Danh sách sinh viên nguy cơ cao
                    </div>
                    <div class="ai-risk-table-wrapper">
                      <table class="ai-risk-table" *ngIf="analysis as a">
                        <thead>
                          <tr>
                            <th>MSSV</th>
                            <th>Họ tên</th>
                            <th>Vắng</th>
                            <th>Vắng liên tiếp</th>
                            <th>Mức rủi ro</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr *ngFor="let s of a.highRiskStudents">
                            <td>{{ s.studentCode }}</td>
                            <td>{{ s.fullName }}</td>
                            <td>{{ s.absentCount }} buổi</td>
                            <td><!-- không có trường vắng liên tiếp trong payload; để trống hoặc tính thêm --></td>
                            <td>
                              <span class="ai-risk-chip" [ngClass]="{
                                'high': (s.riskScore || 0) >= 70,
                                'medium': (s.riskScore || 0) >= 40 && (s.riskScore || 0) < 70,
                                'low': (s.riskScore || 0) < 40
                              }">
                                {{ (s.riskScore || 0) >= 70 ? 'HIGH' : ((s.riskScore || 0) >= 40 ? 'MEDIUM' : 'LOW') }}
                              </span>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                      <p class="ai-risk-note">
                        Danh sách trên được xác định dựa trên số buổi vắng và số buổi vắng liên tiếp
                        trong 4 tuần gần nhất.
                      </p>
                    </div>
                  </section>
                </div>
              </div>

              <!-- Ghi chú nguồn dữ liệu -->
              <div class="ai-footer-note" *ngIf="loading">Đang tải phân tích AI…</div>
              <div class="ai-footer-note" *ngIf="error">{{ error }}</div>
              <div class="ai-footer-note" *ngIf="!loading && !error && !analysis">Chưa có dữ liệu phân tích.</div>
            </div>
          </div>
        </div>
        <!-- /page-view -->
      </div>
    </main>
  </div>
</body>
